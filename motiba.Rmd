---
title: "Μοτίβα"
author: "Κώστας Κούδας"
cache: TRUE
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
```

```{r, echo=F}
rm(list = ls())
```


#   Διάγραμμα υστέρησης

Στην ενότητα αυτή θ’ ασχοληθούμε με τις στρατιωτικές συρράξεις στον κόσμο, με τα πλήθη των τουριστών, με τη μέση μηνιαία θερμοκρασία στη Νέα Υόρκη και με τα θανατηφόρα αεροπορικά δυστυχήματα. Τα δεδομένα γι’ αυτά τα αντλήσαμε από το [Our World in Data](https://ourworldindata.org/) και το [kaggle](https://www.kaggle.com/) με τα ονόματα conflicts.csv, tourism.csv, average_monthly_temperature_by_state_1950-2022.csv και fatal-airliner-accidents-per-million-flights.csv.

-   **conflicts.csv**

```{r echo = F, results='asis', message=FALSE}
conflicts <- read.csv("conflicts.csv")
knitr::kable(conflicts) %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "200px")
```

-   **tourism.csv**

```{r echo = F, results='asis', message=FALSE}
tourism <- read.csv("tourism.csv")
knitr::kable(tourism) %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = "max-content", height = "200px")
```

-   **average_monthly_temperature_by_state_1950-2022.csv** (οι πρώτες 100 γραμμές)

```{r echo = F, results='asis', message=FALSE}
average_monthly_temperature_by_state_1950_2022 <- read.csv("average_monthly_temperature_by_state_1950-2022.csv")
knitr::kable(head(average_monthly_temperature_by_state_1950_2022, n=100)) %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = "100%", height = "200px")
```

-   **fatal-airliner-accidents-per-million-flights.csv**

```{r echo = F, results='asis', message=FALSE}
fatal_airliner_accidents_per_million_flights <- read.csv("fatal-airliner-accidents-per-million-flights.csv")
knitr::kable(fatal_airliner_accidents_per_million_flights) %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = "max-content", height = "200px")
```

##    Ύπαρξη τάσης και λευκός θόρυβος

Αρχικά συλλέξαμε τα στοιχεία για τις ένοπλες συγκρούσεις που γινόντουσαν παγκοσμίως και τα μετατρέψαμε σε χρονικές σειρές [κατά τα γνωστά](timeBasic.html#2_Καταχώρηση_χρονοσειράς).

```{r}
sigkroysis <- conflicts[conflicts$Entity == "World", c(3,4,5,6,7)]
sigkroysis_ts <- ts(sigkroysis[ , c(2,3,4,5)], start = 1946, frequency = 1)
```

Ενδιαφερόμαστε συγκεκριμένα για τις συρράξεις μεταξύ κρατών, όπως και για τους εμφυλίους πολέμους χωρίς τη μεσολάβηση ξένων κρατών. Συνεπώς γράφουμε:

```{r}
sigkrKraton <- sigkroysis$Number.of.conflicts.between.states
emfilii <- sigkroysis$Number.of.civil.conflicts.with.foreign.state.intervention
sigkrKraton_ts <- ts(sigkrKraton, start = 1946, frequency = 1)
emfilii_ts <- ts(emfilii, start = 1946, frequency = 1)
```

Σε πρώτη φάση θα σχεδιάσουμε τα χρονοδιαγράμματα των παγκόσμιων συρράξεων και των εμφυλίων πολέμων. Αυτό όμως απαιτεί το πακέτο `forecast`, οπότε πρώτα γράφουμε:

```{r, message=F}
if(!require(forecast)){
    install.packages("forecast")
    library(forecast)
}
```

Έτσι, [όπως μάθαμε](timeBasic.html#31_Συνήθη_χρονοδιαγράμματα):

```{r}
autoplot(sigkrKraton_ts)
autoplot(emfilii_ts)
```

Παρατηρούμε πως ενώ οι εμφύλιοι πόλεμοι έχουν μια αυξητική τάση, οι παγκόσμιες συρράξεις δεν φαίνεται ν’ ακολουθούν κάποιο μοτίβο. Σε γενικές γραμμές, την τελευταία τεσσαρακονταετία τουλάχιστον, κάθε χρόνο φαίνεται οι εμφύλιοι να σχετίζονται με τους εμφυλίους του προηγούμενου έτους, με την έννοια ότι συνήθως είναι περισσότεροι από αυτούς. Αντιθέτως οι συρράξεις του ενός έτους δεν φαίνονται να έχουν κάποια σχέση με του προηγούμενου.

Θα μπορούσαμε αυτό να το δούμε κάπως καλύτερα; Η απάντηση είναι «ναι». Σε [άλλη ενότητα](metrasysxetisis.html#1_Συντελεστής_γραμμικής_συσχέτισης_Pearson) είχαμε δει την έννοια της γραμμικής συσχέτισης και το [διαγράμματος διασποράς](diagramSysxet.html#1_Διάγραμμα_διασποράς). Για να δούμε κατά πόσον κάθε χρονιά σχετίζεται με την προηγούμενη, θα προσπαθήσουμε να δούμε αν συσχετίζεται η αλληλουχία γεγονότων των ετών 1946-2020 με την αλληλουχία γεγονότων των ετών 1946-2019. Έτσι, θα κάνουμε το διάγραμμα διασποράς, όπου στην οριζόντια γραμμή θα είναι τα πλήθη των εμφυλίων πολέμων τα έτη 1946-2019 και στην κατακόρυφη γραμμή θα είναι οι εμφύλιοι κατά τα έτη 1947-2020. Κάθε κουκκίδα του εν λόγω διαγράμματος θα αντιστοιχεί τους εμφυλίους του ενός έτους στους εμφυλίους του επόμενου.

Λογικά σκεπτόμενοι, περιμένουμε ότι η ύπαρξη μοτίβου θα προκαλεί ισχυρή γραμμική συσχέτιση των ετών 1946-2019 με τα έτη 1947-2020. Οπότε περιμένουμε να δούμε μια ευθεία γραμμή στην περίπτωση των εμφυλίων και κάτι πιο ακανόνιστο στην περίπτωση των διακρατικών συγκρούσεων.

Αυτό το διάγραμμα διασποράς που συζητάμε έχει συγκεκριμένο όνομα, λέγεται **διάγραμμα υστέρησης** και υπολογίζεται γράφοντας:

```{r}
gglagplot(sigkrKraton_ts, continuous = TRUE, set.lags = 1)
gglagplot(emfilii_ts, continuous = TRUE, set.lags = 1)
```

Η κλίμακα του μπλε υποδηλώνει σε ποιο σημείο της ογδοντακονταετίας αντιστοιχεί το κάθε σημείο του γραφήματος υστέρησης.

Φυσικά, δεν είναι ανάγκη να συγκρίνουμε τα έτη που ερευνάμε με τα αμέσως προηγούμενα. Μπορούμε να εξετάσουμε αν υπάρχει συσχέτιση μεταξύ κάποιων ετών και κάποιων πιο προηγούμενων. Με τους κάτωθι κώδικες θα δούμε ποια η σχέση του κάθε έτους με αυτό του αμέσως προηγούμενου (`lag = 1`), του προπέρσινου (`lag = 2`), του της προηγούμενης δεκαετίας (`lag = 10`) και του της προηγούμενης πεντηκονταετίας (`lag = 50`).

```{r}
gglagplot(sigkrKraton_ts, continuous = TRUE, set.lags = c(1, 2, 10, 50))
gglagplot(emfilii_ts, continuous = TRUE, set.lags = c(1, 2, 10, 50))
```

Παρατηρούμε ότι στην περίπτωση των πολέμων μεταξύ των κρατών το γράφημα υστέρησης εξακολουθεί να είναι ένα κουβάρι, οπότε δεν είδαμε κάτι καινούριο. Στην περίπτωση των εμφυλίων πολέμων όμως βλέπουμε αλλαγές, βλέπουμε να πατσαβουριάζεται σιγά-σιγά η ωραία μας ευθεία που είχαμε αρχικά. Αυτό υποδηλώνει τη μειωμένη συσχέτιση του παρόντος έτους με τα πιο προηγούμενα.

Αξίζει να παρατηρήσει ο αναγνώστης το ότι το γράφημα υστέρησης βρίσκεται πάνω από την διαγώνιο (την $y=x$), όπερ ενδεικτικό των περιπτώσεων που έχουμε αυξητική τάση.

Προς επίρρωση των παραπάνω θα κάνουμε και μια ανάλογη έρευνα που να αφορά τους τουρίστες. Κατ’ αρχάς τους εισάγουμε ως χρονική σειρά:

```{r}
toyristEU <- tourism[tourism$Entity == "Europe", 4]
toyristEU_ts <- ts(toyristEU, start = 1995, frequency = 1)
```

Ακολούθως κάνουμε το χρονοδιάγραμμα:

```{r}
autoplot(toyristEU_ts)
```

Βλέπουμε εδώ την πτωτική τάση που είχε ο τουρισμός στην περίοδο του κορωνοϊού. Θα εξαιρέσουμε αυτή την περίοδο, για να εξετάσουμε τις ομαλές καταστάσεις.

```{r}
toyristEU_ts18 <- window(toyristEU_ts, end = 2018)
```

Εφόσον οι τουριστικές αυξήσεις έχουν αυξητική τάση, περιμένουμε πάλι ένα διάγραμμα υστέρησης σχεδόν ευθεία γραμμή πάνω από τη διαγώνιο $y=x$.

```{r}
gglagplot(toyristEU_ts18, continuous = TRUE, set.lags = c(1, 2, 3, 4))
```

Ας πάμε όμως να εξετάσουμε το τι γίνεται με την μεταβολή των τουριστών. Θα προσπαθήσουμε να δούμε πως συμπεριφέρεται στο χρόνο η μεταβολή των τουριστών από έτος σε έτος. Αυτό θα το δούμε χρησιμοποιώντας τη συνάρτηση `diff()` ως ακολούθως:

```{r}
metaboliTour <- diff(toyristEU_ts18)
```

Γράφουμε:

```{r}
autoplot(metaboliTour)
```


Βλέπουμε τον ακανόνιστο χαρακτήρα που έχουν οι μεταβολές των τουριστικών αφίξεων. Άλλοτε έρχονται έως και 60 δισεκατομμύρια παραπάνω τουρίστες από την προηγούμενη χρονιά, άλλες φορές μόνο μερικές χιλιάδες, ενώ σε κάποιες χρονιές ήρθαν και λιγότεροι από την προηγούμενη χρονιά (αρνητική διαφορά).

Πώς αντικατοπτρίζεται αυτό στο γράφημα υστέρησης; Γράφουμε:

```{r}
gglagplot(metaboliTour, continuous = TRUE, set.lags = c(1, 2, 3, 4))
```

Κι έτσι βλέπουμε και πάλι ένα κουβάρι που υποδηλώνει την απουσία οποιασδήποτε τάσης.

Τι γίνεται όμως όταν έχουμε πτωτική τάση; Ας μελετήσουμε τα αεροπορικά δυστυχήματα, για να το δούμε. Γράφουμε:

```{r}
aeropAtyx_ts <- ts(fatal_airliner_accidents_per_million_flights$Fatal.accidents.per.million.commercial.flights, start = 1995, frequency = 1)
autoplot(aeropAtyx_ts)
```

Κι έτσι έχουμε το χρονόγραμμα από το ποσοστό (τοις χιλίοις) των αεροπορικών πτήσεων που κατέληξαν θανατηφόρες.

Παρατηρούμε την πτωτική τάση που έχουν τα δυστυχήματα, αλλά θα τη δούμε και με ένα διάγραμμα υστέρησης γράφοντας:

```{r}
gglagplot(aeropAtyx_ts, continuous = TRUE, set.lags = c(1, 10, 20))
```

Παρατηρούμε ότι και πάλι έχουμε σχεδόν ευθεία γραμμή, ίδιον της ύπαρξης τάσης. Αυτή τη φορά όμως, αφού έχουμε πτωτική τάση, το γράφημά μας είναι κάτω από τη διαγώνιο $y=x$.

##    Εποχικότητα

Πάμε τώρα να δούμε πώς αντικατοπτρίζεται η εποχικότητα σε ένα διάγραμμα υστέρησης. Τι συμβαίνει σε αυτό όταν έχουμε επαναλαμβανόμενες τιμές, όπως είναι οι θερμοκρασίες της Νέας Υόρκης κατά τη διάρκεια του έτους.

Σε πρώτη φάση τις συλλέγουμε και τις μετατρέπουμε σε κλίμακα Κελσίου (ήταν σε Φαρενάιτ):

```{r}
thermNYf <- average_monthly_temperature_by_state_1950_2022[average_monthly_temperature_by_state_1950_2022$state == "New York", 5]
thermNY <- (5*thermNYf-160)/9
```

Ακολούθως τις καταχωρούμε ως χρονική σειρά και κάνουμε το χρονόγραμμά τους:

```{r}
thermNY_ts <- ts(thermNY, start = c(1950,1), frequency = 12)
autoplot(thermNY_ts)
```

Βλέπουμε λοιπόν ότι οι θερμοκρασίες κυμαίνονται μεταξύ των 20°C περίπου και των -10°C, με τον κύκλο αυτόν να επαναλαμβάνεται ετησίως.

Για να σχεδιάσουμε το διάγραμμα υστέρησης γράφουμε:

```{r}
gglagplot(thermNY_ts, continuous = TRUE, set.lags = 1:12)
```

Βλέπουμε ότι η συσχέτιση με την περίοδο προ 12 μηνών είναι πολύ ισχυρή. Φυσικά, δεν χρειαζόταν να έχει κανείς διδακτορικό στις χρονοσειρές για να σκεφτεί ότι πριν από 12 μήνες από σήμερα ήταν ο ίδιος μήνας, άρα θα είχε πάνω-κάτω την ίδια θερμοκρασία τότε με τώρα. Το αναφέρουμε εδώ αυτό μόνο για λόγους επεξήγησης του γραφήματος.

Εύλογη είναι και η ευθεία γραμμή στο lag 6, η οποία αυτή τη φορά είναι κατά μήκος της άλλης διαγώνιου, της $y=-x$. Τι μάς λέει αυτή; Ότι πριν από 6 μήνες τα πράγματα ήταν ακριβώς ανάποδα από θερμοκρασιακής απόψεως: αν τώρα έχει κρύο, τότε είχε ζέστη, κι αντίστροφα.

Τέλος, θα πρέπει να επισημάνουμε ότι οι ελλείψεις στα άλλα lag υποδεικνύουν την ομαλότητα της επανάληψης και τον ημιτονοειδή χαρακτήρα της.

#    ∆ιάγραµµα αυτοσυσχέτισης

Στην προηγούμενη ενότητα είδαμε πόσο σημαντική είναι η αυτοσυσχέτηση στη διάκριση τάσεων ή εποχικότητας σε μια χρονοσειρά. Το διάγραμμα αυτοσυσχέτισης δείχνει το πόσο πολύ συσχετίζεται η χρονοσειρά μας με την εκάστοτε υστέρηση (lag 1, lag 2 κτλ). Το μέτρο συσχέτισης είναι μια παραλλαγή του συντελεστή γραμμικής συσχέτισης του Pearson και το εν λόγω διάγραμμα κατασκευάζεται χρησιμοποιώντας τη συνάρτηση `acf()`.

##   Ύπαρξη τάσης

Θ’ αρχίσουμε με την περίπτωση των εμφυλίων πολέμων και των αεροπορικών δυστυχημάτων. Είχαμε δει προηγουμένως ότι οι μεν έχουν αυξητική τάση, ενώ τα δε έχουν πτωτική τάση. Ας δούμε πώς αυτά αποτυπώνονται στο διάγραμμα αυτοσυσχέτισης:

```{r}
acf(emfilii_ts)
acf(aeropAtyx_ts)
```

Και στις δύο περιπτώσεις το διάγραμμα αυτοσυσχέτισης είχε πτωτική πορεία, όπερ χαρακτηριστικό των περιπτώσεων όπου έχουμε κάποια αυξητική ή πτωτική τάση.

##    Εποχικότητα

Ας πάμε να μελετήσουμε το διάγραμμα αυτοσυσχέτισης στην περίπτωση που έχουμε εποχικότητα. Τι περιμένουμε να δούμε στην περίπτωση των θερμοκρασιών στη Νέα Υόρκη; Γράφουμε:

```{r}
acf(thermNY_ts)
```

Έτσι, βλέπουμε ότι σε κάθε ένα έτος έχουμε τέλεια θετική συσχέτιση, αφού πρακτικά βρισκόμαστε στον ίδιο μήνα. Από την άλλη έχουμε τέλεια αρνητική συσχέτιση κάθε μισό έτος, αφού αν τώρα εμείς έχουμε καλοκαίρι, πριν από 6 μήνες θα είχαμε χειμώνα. Εν ολίγοις το διάγραμμα αυτοσυσχέτισης σε αυτή την περίπτωση έχει ένα επαναλαμβανόμενο μοτίβο.

##    Λευκός θόρυβος

Τι συμβαίνει τώρα στις περιπτώσεις όπου έχουμε περιπτώσεις σαν τις μεταβολές τουριστικών αφίξεων που είναι ένας αχταρμάς; Πώς εμφανίζεται το διάγραμμα αυτοσυσχέτισης όταν δεν υπάρχει κάποια συσχέτιση; Ας το δούμε γράφοντας:

```{r}
acf(metaboliTour)
```

Αν εξαιρέσουμε το lag 0 που παριστάνει τη συσχέτιση της χρονοσειράς μας με… τον εαυτό της, σε κάθε άλλη περίπτωση έχουμε συσχετίσεις που περικλείονται όλες τους ανάμεσα στις δύο οριζόντιες μπλε γραμμές. Αυτό δείχνει την απουσία οιασδήποτε συσχέτισης, με τον τρόπο που έχουμε δηλώσει εμείς έως τώρα.

Στο σημείο αυτό αξίζει να εξετάσουμε την περίπτωση των διακρατικών συρράξεων γράφοντας:

```{r}
acf(sigkrKraton_ts) 
```

Βλέπουμε ότι το κάθε έτος δεν είναι εντελώς άσχετο με όσα έχουν προηγηθεί. Το χρονόγραμμα και το διάγραμμα υστέρησης δεν μπορούσαν να μας δείξουν καθαρά τι συμβαίνει, εδώ όμως βλέπουμε ότι υπάρχει μια μέτρια προς ισχυρή γραμμική συσχέτιση με τα 5 προηγούμενα έτη, πράγμα που αποδεικνύει ότι η πορεία των συγκρούσεων δεν είναι εντελώς τυχαία, δεν είναι λευκός θόρυβος.

Συνολικά γράψαμε τον κάτωθι κώδικα.

```{r, eval=F}
sigkroysis <- conflicts[conflicts$Entity == "World", c(3,4,5,6,7)]
sigkroysis_ts <- ts(sigkroysis[ , c(2,3,4,5)], start = 1946, frequency = 1)
sigkrKraton <- sigkroysis$Number.of.conflicts.between.states
emfilii <- sigkroysis$Number.of.civil.conflicts.with.foreign.state.intervention
sigkrKraton_ts <- ts(sigkrKraton, start = 1946, frequency = 1)
emfilii_ts <- ts(emfilii, start = 1946, frequency = 1)
if(!require(forecast)){
    install.packages("forecast")
    library(forecast)
}
autoplot(sigkrKraton_ts)
autoplot(emfilii_ts)
gglagplot(sigkrKraton_ts, continuous = TRUE, set.lags = 1)
gglagplot(emfilii_ts, continuous = TRUE, set.lags = 1)
gglagplot(sigkrKraton_ts, continuous = TRUE, set.lags = c(1, 2, 10, 50))
gglagplot(emfilii_ts, continuous = TRUE, set.lags = c(1, 2, 10, 50))
toyristEU <- tourism[tourism$Entity == "Europe", 4]
toyristEU_ts <- ts(toyristEU, start = 1995, frequency = 1)
autoplot(toyristEU_ts)
toyristEU_ts18 <- window(toyristEU_ts, end = 2018)
gglagplot(toyristEU_ts18, continuous = TRUE, set.lags = c(1, 2, 3, 4))
metaboliTour <- diff(toyristEU_ts18)
autoplot(metaboliTour)
gglagplot(metaboliTour, continuous = TRUE, set.lags = c(1, 2, 3, 4))
aeropAtyx_ts <- ts(fatal_airliner_accidents_per_million_flights$Fatal.accidents.per.million.commercial.flights, start = 1995, frequency = 1)
autoplot(aeropAtyx_ts)
gglagplot(aeropAtyx_ts, continuous = TRUE, set.lags = c(1, 10, 20))
thermNYf <- average_monthly_temperature_by_state_1950_2022[average_monthly_temperature_by_state_1950_2022$state == "New York", 5]
thermNY <- (5*thermNYf-160)/9
thermNY_ts <- ts(thermNY, start = c(1950,1), frequency = 12)
autoplot(thermNY_ts)
gglagplot(thermNY_ts, continuous = TRUE, set.lags = 1:12)
acf(emfilii_ts)
acf(aeropAtyx_ts)
acf(thermNY_ts)
acf(metaboliTour)
acf(sigkrKraton_ts) 
```



















